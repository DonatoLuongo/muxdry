{% extends 'base.html' %}
{% load static %}

{% block title %}Mis Pedidos - MUXDRY{% endblock %}

{% block content %}
<section class="current-orders-section">
    <div class="current-orders-container">
        <div class="profile-header__custom-ui-2 current-orders-header">
            <div class="profile-avatar__custom-ui-2">
                <img src="{% static 'assets/Perfil-Default.jpeg' %}" alt="Perfil" class="profile-logo__custom-ui-2">
            </div>
            <div class="profile-info__custom-ui-2">
                <h1 class="profile-name__custom-ui-2">{{ user.get_full_name|default:user.username }}</h1>
                <p class="profile-email__custom-ui-2">{{ user.email|default:"" }}</p>
            </div>
            <span class="current-orders-online"><i class="fas fa-circle"></i> En línea</span>
        </div>

        {% if user.is_staff %}
        <div class="current-orders-admin-module">
            <a href="{% url 'orders:admin_orders' %}" class="admin-module-link"><i class="fas fa-clipboard-list"></i> Panel de solicitudes (Admin)</a>
            <span class="admin-module-desc">Ver y gestionar todas las solicitudes de pedidos.</span>
        </div>
        {% endif %}

        <h2 class="current-orders-title">Mis pedidos actuales</h2>
        <p class="current-orders-subtitle">Pedidos en curso: pendientes, confirmados, en proceso o enviados.</p>

        <div class="current-orders-filters">
            <div class="orders-filter-row">
                <span class="orders-filter-label">Período:</span>
                <a href="?{% if filtro_date %}date={{ filtro_date }}{% endif %}{% if filtro_q %}{% if filtro_date %}&{% endif %}q={{ filtro_q }}{% endif %}" class="orders-filter-btn {% if not filtro_period %}active{% endif %}">Todos</a>
                <a href="?period=3m{% if filtro_date %}&date={{ filtro_date }}{% endif %}{% if filtro_q %}&q={{ filtro_q }}{% endif %}" class="orders-filter-btn {% if filtro_period == '3m' %}active{% endif %}">Últimos 3 meses</a>
                <a href="?period=year{% if filtro_date %}&date={{ filtro_date }}{% endif %}{% if filtro_q %}&q={{ filtro_q }}{% endif %}" class="orders-filter-btn {% if filtro_period == 'year' %}active{% endif %}">Este año</a>
            </div>
            <form method="get" class="orders-search-form">
                {% if filtro_period %}<input type="hidden" name="period" value="{{ filtro_period }}">{% endif %}
                <label>
                    <span>Fecha</span>
                    <input type="date" name="date" value="{{ filtro_date|default:'' }}">
                </label>
                <label>
                    <span>Buscar nº pedido</span>
                    <input type="text" name="q" placeholder="Ej: MUX-20260203" value="{{ filtro_q|default:'' }}">
                </label>
                <button type="submit"><i class="fas fa-search"></i> Buscar</button>
            </form>
        </div>

        <p class="orders-search-feedback">
            {% if filtro_period or filtro_date or filtro_q %}
            <i class="fas fa-filter"></i> Filtros aplicados. Resultado: <strong>{{ page_obj.paginator.count }}</strong> pedido(s) con los criterios seleccionados.
            {% else %}
            <i class="fas fa-list"></i> Mostrando todos tus pedidos actuales: <strong>{{ page_obj.paginator.count }}</strong> pedido(s).
            {% endif %}
        </p>

        <div class="current-orders-list">
            {% for pedido, unread_count in pedidos_with_unread %}
            <div class="profile-order-card__custom-ui-2 current-order-card">
                <div class="order-header__custom-ui-2">
                    <span class="order-id__custom-ui-2">#{{ pedido.order_number }}</span>
                    <span class="order-date__custom-ui-2">{{ pedido.created_at|date:"d M Y" }}</span>
                    <span class="order-status__custom-ui-2 processing">{{ pedido.get_status_display }}</span>
                </div>
                <div class="order-summary__custom-ui-2">
                    {% for item in pedido.items.all %}
                    <div class="order-product-preview__custom-ui-2">
                        <img src="{% if item.product.image %}{{ item.product.image.url }}{% else %}{% static 'assets/products/Drysol/Drysol-2.png' %}{% endif %}" alt="{{ item.product.name }}" class="order-product-img__custom-ui-2">
                        <div>
                            <h3 class="order-product-name__custom-ui-2">{{ item.product.name }}</h3>
                            <p class="order-product-desc__custom-ui-2">Cantidad: {{ item.quantity }} × ${{ item.price }}</p>
                        </div>
                    </div>
                    {% endfor %}
                    <div class="order-meta__custom-ui-2">
                        <div class="order-meta-item__custom-ui-2">
                            <span class="meta-label__custom-ui-2">Total:</span>
                            <span class="meta-value__custom-ui-2">${{ pedido.total }}</span>
                        </div>
                        <div class="order-meta-item__custom-ui-2">
                            <span class="meta-label__custom-ui-2">Método de pago:</span>
                            <span class="meta-value__custom-ui-2">{{ pedido.get_payment_method_display }}</span>
                        </div>
                    </div>
                </div>
                <div class="order-action-btns">
                    <button type="button" class="order-detail-btn" data-order-id="{{ pedido.id }}"><i class="fas fa-eye"></i> Ver mi pedido</button>
                    <button type="button" class="order-messages-btn" data-order-id="{{ pedido.id }}" data-order-number="{{ pedido.order_number }}">
                        <i class="fas fa-comment-alt"></i> Mensajes
                        {% if unread_count %}<span class="order-unread-badge" title="Tiene un nuevo mensaje por leer">{{ unread_count }}</span>{% endif %}
                    </button>
                    {% if pedido.status == 'delivered' %}
                    <a href="{% url 'orders:invoice' pedido.id %}" class="order-invoice-btn" target="_blank" rel="noopener" title="Ver factura"><i class="fas fa-file-invoice"></i> Ver factura</a>
                    {% endif %}
                </div>
                {% if pedido.status == 'pending' or pedido.status == 'confirmed' %}
                <form method="post" action="{% url 'orders:cancel_order' %}" class="order-cancel-form" onsubmit="return confirm('¿Cancelar este pedido? Se notificará al administrador.');">
                    {% csrf_token %}
                    <input type="hidden" name="order_id" value="{{ pedido.id }}">
                    <input type="hidden" name="reason" value="Usuario indica que ya no está interesado">
                    <button type="submit" class="order-cancel-btn"><i class="fas fa-times-circle"></i> Ya no estoy interesado</button>
                </form>
                {% endif %}
            </div>
            {% empty %}
            <div class="no-orders-message current-orders-empty no-orders-card">
                <div class="no-orders-icon-wrap"><i class="fas fa-clipboard-list"></i></div>
                <h3>No tienes pedidos actuales</h3>
                <p>Tu historial de pedidos en curso aparecerá aquí. Cuando realices una compra, podrás rastrear el estado y ver los detalles desde esta sección.</p>
                <a href="{% url 'home' %}" class="button primary no-orders-cta"><i class="fas fa-store"></i> Ir a la tienda</a>
            </div>
            {% endfor %}
        </div>

        {% if page_obj.paginator.num_pages > 1 %}
        <nav class="orders-pagination-nav">
            {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% if filtro_period %}&period={{ filtro_period }}{% endif %}{% if filtro_date %}&date={{ filtro_date }}{% endif %}{% if filtro_q %}&q={{ filtro_q }}{% endif %}" class="pagination-btn">Página anterior</a>
            {% else %}
            <span class="pagination-btn pagination-btn--disabled">Página anterior</span>
            {% endif %}
            {% for n in page_obj.paginator.page_range %}
            {% if page_obj.number == n %}
            <span class="pagination-btn pagination-btn--active">{{ n }}</span>
            {% else %}
            <a href="?page={{ n }}{% if filtro_period %}&period={{ filtro_period }}{% endif %}{% if filtro_date %}&date={{ filtro_date }}{% endif %}{% if filtro_q %}&q={{ filtro_q }}{% endif %}" class="pagination-btn">{{ n }}</a>
            {% endif %}
            {% endfor %}
            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if filtro_period %}&period={{ filtro_period }}{% endif %}{% if filtro_date %}&date={{ filtro_date }}{% endif %}{% if filtro_q %}&q={{ filtro_q }}{% endif %}" class="pagination-btn">Página siguiente</a>
            {% else %}
            <span class="pagination-btn pagination-btn--disabled">Página siguiente</span>
            {% endif %}
        </nav>
        {% endif %}
    </div>
</section>

<!-- Modal Ver mi pedido -->
<div id="order-detail-modal" class="order-modal-overlay">
    <div class="order-modal-content">
        <button type="button" class="order-modal-close" id="close-detail-modal">&times;</button>
        <h2 class="order-modal-title"><i class="fas fa-file-alt"></i> Detalles del pedido <span id="detail-order-id"></span></h2>
        <div id="order-detail-body"></div>
    </div>
</div>

<!-- Modal Mensajes -->
<div id="order-messages-modal" class="order-modal-overlay">
    <div class="order-modal-content order-modal-content--chat">
        <button type="button" class="order-modal-close" id="close-messages-modal">&times;</button>
        <h2 class="order-modal-title"><i class="fas fa-comments"></i> Mensajes - Pedido <span id="messages-order-id"></span></h2>
        <div class="order-chat-messages" id="order-chat-messages"></div>
        <div class="order-chat-reply" id="order-chat-reply">
            <div id="reply-wait-notice" class="reply-wait-notice" style="display:none;">
                <i class="fas fa-info-circle"></i> Espera a que el administrador se ponga en contacto contigo. Podrás responder cuando recibas el primer mensaje.
            </div>
            <div id="reply-form-wrap" style="display:none;">
                <label><span>Responder o enviar comprobante de pago</span></label>
                <textarea id="reply-message-input" placeholder="Escribe tu mensaje o descripción del comprobante..."></textarea>
                <div class="reply-row">
                    <input type="file" id="reply-image-input" accept="image/png,image/jpeg,image/jpg" title="Adjuntar comprobante (PNG o JPG, máx. 10MB)">
                    <button type="button" class="reply-btn" id="reply-send-btn"><i class="fas fa-paper-plane"></i> Enviar</button>
                </div>
                <p class="reply-hint"><i class="fas fa-exclamation-circle"></i> Solo PNG o JPG. Máximo 10 MB. El administrador revisará tu comprobante.</p>
            </div>
        </div>
    </div>
</div>

<!-- Lightbox para ampliar imágenes -->
<div id="order-image-lightbox" class="order-lightbox">
    <button type="button" class="order-lightbox-close" id="close-lightbox">&times;</button>
    <img id="lightbox-img" src="" alt="Comprobante">
</div>
{% endblock %}

{% block extra_css %}
<style>
.current-orders-section { padding: 2rem 1rem 4rem; background: #f5f6f8; min-height: 60vh; }
.current-orders-container { max-width: 900px; margin: 0 auto; }
.current-orders-header {
    display: flex; align-items: center; gap: 1.5rem;
    background: #fff; padding: 1.5rem 2rem; border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.06); margin-bottom: 2rem;
}
.current-orders-header .profile-name__custom-ui-2 { color: #0d0d0d; font-size: 1.35rem; margin: 0 0 0.25rem 0; font-weight: 600; }
.current-orders-header .profile-email__custom-ui-2 { color: #333; font-size: 0.95rem; margin: 0; }
.current-orders-admin-module {
    background: linear-gradient(135deg, #0A2B32 0%, #284660 100%); color: #fff; padding: 1rem 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;
    display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;
}
.current-orders-admin-module .admin-module-link {
    color: #fff; font-weight: 600; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;
}
.current-orders-admin-module .admin-module-link:hover { text-decoration: underline; }
.current-orders-admin-module .admin-module-desc { font-size: 0.9rem; opacity: 0.9; }
.current-orders-online { display: inline-flex; align-items: center; gap: 0.35rem; font-size: 0.85rem; color: #0a7c42; margin-left: auto; }
.current-orders-online i { font-size: 0.6rem; }
.current-orders-title { font-size: 1.5rem; font-weight: 700; color: #0A2B32; margin-bottom: 0.25rem; }
.current-orders-subtitle { color: #6c757d; font-size: 0.95rem; margin-bottom: 1.5rem; }
.current-orders-filters { background: #fff; padding: 1.25rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
.orders-filter-row { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap; }
.orders-filter-label { font-weight: 600; color: #444; margin-right: 0.5rem; }
.orders-filter-btn { padding: 6px 14px; border-radius: 6px; background: #f0f0f0; color: #333; text-decoration: none; font-size: 0.9rem; }
.orders-filter-btn:hover { background: #e0e0e0; }
.orders-filter-btn.active { background: #0A2B32; color: #fff; }
.orders-search-form { display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap; }
.orders-search-form label { display: flex; flex-direction: column; gap: 4px; font-size: 0.9rem; }
.orders-search-form input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; }
.orders-search-form button { padding: 8px 16px; background: #0A2B32; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
.current-orders-list { display: flex; flex-direction: column; gap: 1.25rem; }
.current-order-card { background: #fff; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); overflow: hidden; padding-bottom: 1rem; }
.order-cancel-form { margin: 0 1.5rem 1rem; padding-top: 0.75rem; border-top: 1px solid #eee; }
.order-cancel-btn { padding: 8px 14px; background: transparent; border: 1px solid #dc3545; color: #dc3545; border-radius: 6px; font-size: 0.9rem; cursor: pointer; }
.order-cancel-btn:hover { background: #dc3545; color: #fff; }
.current-orders-empty { padding: 3rem 2rem; background: #fff; border-radius: 12px; text-align: center; }
.no-orders-card { width: 100%; max-width: 540px; min-width: 300px; margin: 0 auto; padding: 2.75rem 2.5rem; box-shadow: 0 6px 24px rgba(10,43,50,0.08); border: 1px solid #e0e8ec; border-top: 4px solid #0A2B32; box-sizing: border-box; border-radius: 12px; background: #fff; }
.no-orders-card .no-orders-icon-wrap { width: 76px; height: 76px; margin: 0 auto 1.5rem; background: linear-gradient(145deg, #f0f7fa 0%, #e2eef4 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 12px rgba(10,43,50,0.06); }
.no-orders-card .no-orders-icon-wrap i { font-size: 1.85rem; color: #0A2B32; }
.no-orders-card h3 { font-size: 1.3rem; color: #0A2B32; margin-bottom: 0.75rem; font-weight: 700; }
.no-orders-card p { color: #5a6268; font-size: 0.975rem; line-height: 1.65; margin-bottom: 1.5rem; max-width: 36em; margin-left: auto; margin-right: auto; }
.no-orders-card .no-orders-cta { display: inline-flex; align-items: center; gap: 0.5rem; padding: 12px 24px; border-radius: 8px; font-weight: 600; text-decoration: none; background: #0A2B32; color: #fff; transition: background 0.2s, transform 0.2s; }
.no-orders-card .no-orders-cta:hover { background: #0d3840; transform: translateY(-1px); }
.orders-search-feedback { font-size: 0.9rem; color: #5a6268; margin: 0 0 1rem 0; padding: 0.5rem 0; }
.orders-search-feedback i { color: #0A2B32; margin-right: 6px; }
.orders-pagination-nav, .current-orders-pagination { display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin-top: 1.5rem; flex-wrap: wrap; }
.orders-pagination-nav .pagination-btn, .current-orders-pagination .pagination-btn { padding: 8px 14px; border: 1px solid #ddd; border-radius: 6px; background: #fff; color: #333; text-decoration: none; font-size: 0.9rem; }
.orders-pagination-nav .pagination-btn:hover { background: #f0f0f0; }
.orders-pagination-nav .pagination-btn--active { background: #0A2B32 !important; color: #fff !important; border-color: #0A2B32 !important; }
.orders-pagination-nav .pagination-btn--disabled { opacity: 0.6; cursor: not-allowed; }
.order-action-btns { display: flex; gap: 0.75rem; margin: 0 1.5rem 1rem; flex-wrap: wrap; }
.order-detail-btn, .order-messages-btn {
    padding: 8px 14px; border-radius: 6px; font-size: 0.9rem; cursor: pointer; border: 1px solid #0A2B32;
    background: #fff; color: #0A2B32; display: inline-flex; align-items: center; gap: 6px; text-decoration: none;
}
.order-detail-btn:hover, .order-messages-btn:hover { background: #0A2B32; color: #fff; }
.order-invoice-btn {
    padding: 8px 14px; border-radius: 6px; font-size: 0.9rem; display: inline-flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none;
    background: #c97070; color: #fff; border: 1px solid #b85c5c;
}
.order-invoice-btn:hover { background: #b85c5c; color: #fff; }
.order-unread-badge {
    background: #e67e22; color: #fff; font-size: 0.75rem; padding: 2px 6px; border-radius: 10px; margin-left: 4px;
}
.order-modal-overlay {
    display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;
    padding: 1rem; overflow-y: auto;
}
.order-modal-overlay.is-open { display: flex; }
.order-modal-content { background: #fff; border-radius: 12px; max-width: 720px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 1.5rem; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
.order-modal-content--chat { max-width: 720px; }
.order-modal-close { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
.order-chat-messages { max-height: 320px; overflow-y: auto; padding: 1rem 0; }
.order-chat-msg { padding: 10px 12px; margin-bottom: 8px; border-radius: 8px; font-size: 0.95rem; }
.order-chat-msg.admin { background: #e8f4fd; border-left: 4px solid #0A2B32; }
.order-chat-msg.user { background: #f0f0f0; margin-left: 2rem; }
.order-chat-msg-time { font-size: 0.75rem; color: #888; margin-top: 4px; }
.order-chat-msg-img { max-width: 180px; max-height: 120px; cursor: pointer; border-radius: 6px; margin-top: 6px; border: 1px solid #ddd; }
.order-chat-msg-img:hover { opacity: 0.9; }
.order-chat-reply { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee; }
.order-chat-reply textarea { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; min-height: 60px; resize: vertical; font-family: inherit; }
.order-chat-reply .reply-row { display: flex; gap: 0.75rem; margin-top: 8px; align-items: center; flex-wrap: wrap; }
.order-chat-reply .reply-row input[type="file"] { font-size: 0.9rem; }
.order-chat-reply .reply-btn { padding: 8px 16px; background: #0A2B32; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
.order-chat-reply .reply-btn:hover { background: #0d3840; }
.order-chat-reply .reply-hint { font-size: 0.8rem; color: #6c757d; margin-top: 4px; }
.reply-wait-notice { background: #fff3cd; border: 1px solid #ffc107; color: #856404; padding: 10px 12px; border-radius: 8px; font-size: 0.9rem; }
.reply-wait-notice i { margin-right: 6px; }
/* Lightbox */
.order-lightbox { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center; padding: 2rem; }
.order-lightbox.is-open { display: flex; }
.order-lightbox img { max-width: 95%; max-height: 95%; object-fit: contain; border-radius: 8px; }
.order-lightbox-close { position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: #fff; font-size: 2rem; cursor: pointer; }
#order-detail-body .detail-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #eee; font-size: 0.95rem; }
#order-detail-body .detail-row strong { color: #0A2B32; }
</style>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    var detailModal = document.getElementById('order-detail-modal');
    var messagesModal = document.getElementById('order-messages-modal');
    var detailBody = document.getElementById('order-detail-body');
    var messagesContainer = document.getElementById('order-chat-messages');
    var lightbox = document.getElementById('order-image-lightbox');
    var lightboxImg = document.getElementById('lightbox-img');
    var currentMessagesOrderId = null;
    var baseUrl = '{{ request.scheme }}://{{ request.get_host }}';

    function getCsrf() {
        var el = document.querySelector('[name=csrfmiddlewaretoken]');
        return el ? el.value : (document.cookie.match(/csrftoken=([^;]+)/) || [,''])[1];
    }

    function renderMsgImg(url) {
        if (!url) return '';
        var full = url.startsWith('http') ? url : baseUrl + url;
        return '<img src="' + full + '" class="order-chat-msg-img" alt="Comprobante" data-full="' + full + '">';
    }

    function openDetailModal(orderId) {
        fetch('/orders/pedido/' + orderId + '/detalle/')
            .then(function(r) { return r.json(); })
            .then(function(d) {
                document.getElementById('detail-order-id').textContent = '#' + d.order_number;
                var html = '<div class="detail-row"><strong>Fecha</strong><span>' + d.created_at + '</span></div>';
                html += '<div class="detail-row"><strong>Estado</strong><span>' + d.status + '</span></div>';
                html += '<div class="detail-row"><strong>Método de pago</strong><span>' + d.payment_method + '</span></div>';
                html += '<div class="detail-row"><strong>Cédula/RIF</strong><span>' + d.document + '</span></div>';
                html += '<div class="detail-row"><strong>Tipo envío</strong><span>' + d.shipping_type + '</span></div>';
                html += '<div class="detail-row"><strong>Agencia</strong><span>' + d.shipping_agency + '</span></div>';
                html += '<div class="detail-row"><strong>Retiro oficina</strong><span>' + (d.office_pickup ? 'Sí' : 'No') + '</span></div>';
                html += '<div class="detail-row"><strong>Dirección</strong><span>' + d.shipping_address + '</span></div>';
                html += '<div class="detail-row"><strong>Ciudad</strong><span>' + d.shipping_city + '</span></div>';
                html += '<div class="detail-row"><strong>Teléfono</strong><span>' + d.shipping_phone + '</span></div>';
                html += '<div class="detail-row"><strong>Total</strong><span>$' + d.total + '</span></div>';
                html += '<h4 style="margin-top:1rem;color:#0A2B32">Productos</h4>';
                d.items.forEach(function(i) { html += '<div class="detail-row"><span>' + i.name + ' x ' + i.quantity + '</span><span>$' + i.total + '</span></div>'; });
                if (d.notes !== '—') html += '<div class="detail-row"><strong>Notas</strong><span>' + d.notes + '</span></div>';
                if (d.messages && d.messages.length) {
                    html += '<h4 style="margin-top:1.25rem;color:#0A2B32">Mensajes</h4>';
                    d.messages.forEach(function(m) {
                        html += '<div class="order-chat-msg ' + (m.is_from_admin ? 'admin' : 'user') + '" style="margin-bottom:8px;">';
                        html += '<div>' + m.message.replace(/\n/g, '<br>') + '</div>';
                        if (m.image_url) html += renderMsgImg(m.image_url);
                        html += '<div class="order-chat-msg-time">' + m.created_at + (m.is_from_admin ? ' - MUXDRY' : '') + '</div></div>';
                    });
                }
                detailBody.innerHTML = html;
                detailBody.querySelectorAll('.order-chat-msg-img').forEach(function(img) {
                    img.addEventListener('click', function() { openLightbox(this.getAttribute('data-full')); });
                });
                detailModal.classList.add('is-open');
            });
    }

    function openLightbox(src) {
        if (lightboxImg && lightbox) { lightboxImg.src = src; lightbox.classList.add('is-open'); }
    }
    function closeLightbox() { if (lightbox) lightbox.classList.remove('is-open'); }

    function openMessagesModal(orderId) {
        var btn = event.target.closest('.order-messages-btn');
        var num = btn && btn.getAttribute('data-order-number') ? btn.getAttribute('data-order-number') : orderId;
        document.getElementById('messages-order-id').textContent = '#' + num;
        currentMessagesOrderId = orderId;
        document.getElementById('reply-message-input').value = '';
        document.getElementById('reply-image-input').value = '';
        fetch('/orders/pedido/' + orderId + '/mensajes/')
            .then(function(r) { return r.json(); })
            .then(function(d) {
                var html = '';
                var hasAdminMsg = false;
                d.messages.forEach(function(m) {
                    if (m.is_from_admin) hasAdminMsg = true;
                    html += '<div class="order-chat-msg ' + (m.is_from_admin ? 'admin' : 'user') + '">';
                    html += '<div>' + m.message.replace(/\n/g, '<br>') + '</div>';
                    if (m.image_url) html += renderMsgImg(m.image_url);
                    html += '<div class="order-chat-msg-time">' + m.created_at + (m.is_from_admin ? ' - MUXDRY' : '') + '</div></div>';
                });
                messagesContainer.innerHTML = html || '<p style="color:#888">No hay mensajes aún.</p>';
                messagesContainer.querySelectorAll('.order-chat-msg-img').forEach(function(img) {
                    img.addEventListener('click', function() { openLightbox(this.getAttribute('data-full')); });
                });
                document.getElementById('reply-wait-notice').style.display = hasAdminMsg ? 'none' : 'block';
                document.getElementById('reply-form-wrap').style.display = hasAdminMsg ? 'block' : 'none';
                messagesModal.classList.add('is-open');
                if (d.messages.length) messagesContainer.scrollTop = messagesContainer.scrollHeight;
                var badge = btn && btn.querySelector('.order-unread-badge');
                if (badge) badge.remove();
                if (typeof window.refreshOrdersUnreadBadges === 'function') window.refreshOrdersUnreadBadges();
            });
    }

    function sendReply() {
        if (!currentMessagesOrderId) return;
        var msgInput = document.getElementById('reply-message-input');
        var imgInput = document.getElementById('reply-image-input');
        var msg = (msgInput.value || '').trim();
        var file = imgInput.files && imgInput.files[0];
        if (!msg && !file) { alert('Escribe un mensaje o adjunta una imagen.'); return; }
        if (file) {
            var allowed = ['image/png', 'image/jpeg', 'image/jpg'];
            if (allowed.indexOf(file.type) === -1) { alert('Solo se permiten imágenes PNG o JPG.'); return; }
            if (file.size > 10 * 1024 * 1024) { alert('La imagen no debe superar 10 MB.'); return; }
        }
        var fd = new FormData();
        fd.append('message', msg || '(Comprobante de pago adjunto)');
        fd.append('csrfmiddlewaretoken', getCsrf());
        if (file) fd.append('image', file);
        var btn = document.getElementById('reply-send-btn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
        fetch('/orders/pedido/' + currentMessagesOrderId + '/responder/', { method: 'POST', body: fd })
            .then(function(r) { return r.json(); })
            .then(function(res) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar';
                if (res.error) { alert(res.error); return; }
                msgInput.value = ''; imgInput.value = '';
                fetch('/orders/pedido/' + currentMessagesOrderId + '/mensajes/')
                    .then(function(r2) { return r2.json(); })
                    .then(function(d) {
                        var html = '';
                        d.messages.forEach(function(m) {
                            html += '<div class="order-chat-msg ' + (m.is_from_admin ? 'admin' : 'user') + '">';
                            html += '<div>' + m.message.replace(/\n/g, '<br>') + '</div>';
                            if (m.image_url) html += renderMsgImg(m.image_url);
                            html += '<div class="order-chat-msg-time">' + m.created_at + (m.is_from_admin ? ' - MUXDRY' : '') + '</div></div>';
                        });
                        messagesContainer.innerHTML = html || '<p style="color:#888">No hay mensajes aún.</p>';
                        messagesContainer.querySelectorAll('.order-chat-msg-img').forEach(function(img) {
                            img.addEventListener('click', function() { openLightbox(img.getAttribute('data-full')); });
                        });
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    });
            })
            .catch(function() { btn.disabled = false; btn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar'; alert('Error al enviar.'); });
    }

    function closeModal(m) { m.classList.remove('is-open'); }
    document.querySelectorAll('.order-detail-btn').forEach(function(btn) {
        btn.addEventListener('click', function() { openDetailModal(this.getAttribute('data-order-id')); });
    });
    document.querySelectorAll('.order-messages-btn').forEach(function(btn) {
        btn.addEventListener('click', function() { openMessagesModal(this.getAttribute('data-order-id')); });
    });
    if (document.getElementById('close-detail-modal')) document.getElementById('close-detail-modal').onclick = function() { closeModal(detailModal); };
    if (document.getElementById('close-messages-modal')) document.getElementById('close-messages-modal').onclick = function() { closeModal(messagesModal); };
    if (document.getElementById('close-lightbox')) document.getElementById('close-lightbox').onclick = closeLightbox;
    if (lightbox) lightbox.addEventListener('click', function(e) { if (e.target === lightbox) closeLightbox(); });
    if (detailModal) detailModal.addEventListener('click', function(e) { if (e.target === detailModal) closeModal(detailModal); });
    if (messagesModal) messagesModal.addEventListener('click', function(e) { if (e.target === messagesModal) closeModal(messagesModal); });
    if (document.getElementById('reply-send-btn')) document.getElementById('reply-send-btn').addEventListener('click', sendReply);
})();
</script>
{% endblock %}
