{% extends 'base.html' %}
{% load static %}

{% block title %}Panel de solicitudes - Admin - MUXDRY{% endblock %}

{% block content %}
<section class="admin-orders-section">
    <div class="admin-orders-container">
        <div class="admin-orders-header">
            <h1><i class="fas fa-clipboard-list"></i> Panel de solicitudes de pedidos</h1>
            <p>Solo administradores. Aquí puedes ver todas las solicitudes y actualizar su estado.{% if admin_orders_count %} <span class="admin-orders-indicator" title="{{ admin_orders_count }} pedido(s)" style="display:inline-flex;align-items:center;gap:4px;margin-left:8px;padding:4px 10px;background:#dcfce7;color:#166534;border-radius:20px;font-size:0.85rem;"><i class="fas fa-clipboard-list" style="color:#22c55e;"></i> {{ admin_orders_count }} pedido(s)</span>{% endif %}</p>
            <a href="{% url 'orders:current_orders' %}" class="admin-back-link"><i class="fas fa-arrow-left"></i> Volver a Mis pedidos</a>
        </div>

        <div class="admin-orders-filters">
            <form method="get" class="admin-filters-form">
                <label>
                    <span>Estado:</span>
                    <select name="status">
                        <option value="">Todos</option>
                        {% for value, label in status_choices %}
                        <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label>
                    <span>Período:</span>
                    <select name="period">
                        <option value="">Todos</option>
                        <option value="3m" {% if period_filter == '3m' %}selected{% endif %}>Últimos 3 meses</option>
                        <option value="year" {% if period_filter == 'year' %}selected{% endif %}>Este año</option>
                    </select>
                </label>
                <label>
                    <span>Buscar:</span>
                    <input type="text" name="q" value="{{ q_filter|default:'' }}" placeholder="Nº pedido, email...">
                </label>
                <button type="submit"><i class="fas fa-search"></i> Filtrar</button>
            </form>
        </div>

        <p class="admin-orders-feedback">
            {% if orders_with_unread %}
            <i class="fas fa-filter"></i> Resultado de los filtros seleccionados: <strong>{{ page_obj.paginator.count }}</strong> pedido(s) encontrado(s).
            {% else %}
            <i class="fas fa-inbox"></i> No hay pedidos con los filtros seleccionados.
            {% endif %}
        </p>

        <div class="admin-orders-list">
            {% for order, unread_client in orders_with_unread %}
            <div class="admin-order-card">
                <div class="admin-order-main">
                    <div class="admin-order-meta">
                        <strong>#{{ order.order_number }}</strong>
                        <span>{{ order.created_at|date:"d/m/Y H:i" }}</span>
                        <span class="admin-order-status admin-order-status--{{ order.status }}">{{ order.get_status_display }}</span>
                    </div>
                    <div class="admin-order-user">
                        <i class="fas fa-user"></i> {{ order.user.get_full_name|default:order.user.username }} — {{ order.user.email }}
                    </div>
                    <div class="admin-order-items">
                        {% for item in order.items.all %}
                        <span class="admin-order-item">{{ item.product.name }} × {{ item.quantity }} (${{ item.price }})</span>
                        {% endfor %}
                    </div>
                    <div class="admin-order-total">
                        Total: <strong>${{ order.total }}</strong>
                    </div>
                </div>
                <div class="admin-order-actions">
                    <button type="button" class="admin-btn-view admin-order-view-btn" data-order-id="{{ order.id }}" data-order-number="{{ order.order_number }}" title="Ver solicitud completa"><i class="fas fa-eye"></i> Ver solicitud</button>
                    <button type="button" class="admin-btn-msg admin-order-msg-btn" data-order-id="{{ order.id }}" data-order-number="{{ order.order_number }}" title="Conversación con el cliente">
                        <i class="fas fa-comment"></i> Mensaje
                        {% if unread_client %}<span class="admin-msg-unread-badge" title="Respuesta del cliente por leer">{{ unread_client }}</span>{% endif %}
                    </button>
                    {% if order.status == 'delivered' %}
                    <a href="{% url 'orders:invoice' order.id %}" class="admin-btn-invoice" target="_blank" rel="noopener" title="Ver factura"><i class="fas fa-file-invoice"></i> Ver factura</a>
                    {% endif %}
                    <form method="post" action="{% url 'orders:admin_orders' %}" class="admin-status-form">
                        {% csrf_token %}
                        <input type="hidden" name="order_id" value="{{ order.id }}">
                        <select name="new_status">
                            {% for value, label in status_choices %}
                            <option value="{{ value }}" {% if order.status == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit"><i class="fas fa-save"></i> Actualizar</button>
                    </form>
                </div>
            </div>
            {% empty %}
            <div class="admin-orders-empty">
                <i class="fas fa-inbox"></i>
                <p>No hay pedidos con los filtros seleccionados.</p>
            </div>
            {% endfor %}
        </div>

        {% if page_obj.paginator.num_pages > 1 %}
        <nav class="admin-orders-pagination">
            {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if period_filter %}&period={{ period_filter }}{% endif %}{% if q_filter %}&q={{ q_filter }}{% endif %}" class="pagination-btn">Página anterior</a>
            {% else %}
            <span class="pagination-btn pagination-btn--disabled">Página anterior</span>
            {% endif %}
            {% for n in page_obj.paginator.page_range %}
            {% if page_obj.number == n %}
            <span class="pagination-btn pagination-btn--active">{{ n }}</span>
            {% else %}
            <a href="?page={{ n }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if period_filter %}&period={{ period_filter }}{% endif %}{% if q_filter %}&q={{ q_filter }}{% endif %}" class="pagination-btn">{{ n }}</a>
            {% endif %}
            {% endfor %}
            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if period_filter %}&period={{ period_filter }}{% endif %}{% if q_filter %}&q={{ q_filter }}{% endif %}" class="pagination-btn">Página siguiente</a>
            {% else %}
            <span class="pagination-btn pagination-btn--disabled">Página siguiente</span>
            {% endif %}
        </nav>
        {% endif %}
    </div>
</section>

<style>
.admin-orders-section { padding: 2rem 1rem 4rem; background: #f5f6f8; min-height: 60vh; }
.admin-orders-container { max-width: 960px; margin: 0 auto; }
.admin-orders-header { background: #fff; padding: 1.5rem 2rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.06); }
.admin-orders-header h1 { margin: 0 0 0.5rem 0; font-size: 1.5rem; color: #0A2B32; }
.admin-orders-header h1 i { margin-right: 0.5rem; color: #284660; }
.admin-orders-header p { margin: 0 0 1rem 0; color: #6c757d; font-size: 0.95rem; }
.admin-back-link { display: inline-block; color: #0A2B32; text-decoration: none; font-weight: 500; }
.admin-back-link:hover { text-decoration: underline; }
.admin-orders-filters { background: #fff; padding: 1.25rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
.admin-filters-form { display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end; }
.admin-filters-form label { display: flex; flex-direction: column; gap: 4px; font-size: 0.9rem; }
.admin-filters-form select, .admin-filters-form input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; }
.admin-filters-form button { padding: 8px 16px; background: #0A2B32; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
.admin-orders-feedback { font-size: 0.9rem; color: #5a6268; margin: 0 0 1rem 0; padding: 0.5rem 0; }
.admin-orders-feedback i { color: #0A2B32; margin-right: 6px; }
.admin-orders-list { display: flex; flex-direction: column; gap: 1rem; }
.admin-order-card { display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: start; background: #fff; padding: 1.25rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #e5e9ec; }
@media (max-width: 640px) { .admin-order-card { grid-template-columns: 1fr; } }
.admin-order-meta { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 0.5rem; }
.admin-order-status { padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; }
.admin-order-status--pending { background: #fff3cd; color: #856404; }
.admin-order-status--confirmed { background: #cce5ff; color: #004085; }
.admin-order-status--processing { background: #cfe2ff; color: #084298; }
.admin-order-status--shipped { background: #d1e7dd; color: #0f5132; }
.admin-order-status--delivered { background: #d1e7dd; color: #0f5132; }
.admin-order-status--cancelled { background: #f8d7da; color: #842029; }
.admin-order-user { font-size: 0.9rem; color: #555; margin-bottom: 0.5rem; }
.admin-order-items { font-size: 0.9rem; color: #666; margin-bottom: 0.5rem; }
.admin-order-item { display: inline-block; margin-right: 0.5rem; }
.admin-order-total { font-size: 1rem; }
.admin-order-actions .admin-status-form { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
.admin-order-actions select { padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem; }
.admin-order-actions button { padding: 6px 12px; background: #284660; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; }
.admin-orders-empty { text-align: center; padding: 3rem; background: #fff; border-radius: 12px; color: #6c757d; }
.admin-orders-pagination, .orders-pagination-nav { display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin-top: 1.5rem; flex-wrap: wrap; }
.admin-orders-pagination a, .orders-pagination-nav a { padding: 8px 14px; background: #fff; border: 1px solid #ddd; border-radius: 6px; color: #0A2B32; text-decoration: none; }
.admin-orders-pagination a:hover, .orders-pagination-nav a:hover { background: #f0f0f0; }
.pagination-btn { display: inline-flex; align-items: center; padding: 8px 14px; border: 1px solid #ddd; border-radius: 6px; background: #fff; color: #333; text-decoration: none; font-size: 0.9rem; }
.pagination-btn:hover { background: #f0f0f0; }
.pagination-btn--active { background: #0A2B32 !important; color: #fff !important; border-color: #0A2B32 !important; cursor: default; }
.pagination-btn--disabled { opacity: 0.6; cursor: not-allowed; pointer-events: none; }
.admin-btn-view, .admin-btn-msg { padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; cursor: pointer; border: 1px solid #284660; background: #fff; color: #284660; margin-right: 8px; }
.admin-btn-view:hover, .admin-btn-msg:hover { background: #284660; color: #fff; }
.admin-order-actions { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
.admin-modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; padding: 1rem; }
.admin-modal-overlay.is-open { display: flex; }
.admin-modal-content { background: #fff; border-radius: 12px; max-width: 520px; width: 100%; max-height: 85vh; overflow-y: auto; padding: 1.5rem; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
.admin-modal-content--wide { max-width: 680px; }
.admin-modal-close { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
.admin-detail-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #eee; font-size: 0.95rem; }
.admin-msg-form { margin-top: 1rem; }
.admin-msg-form textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; min-height: 80px; }
.admin-msg-form button { margin-top: 8px; padding: 10px 20px; background: #0A2B32; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
.admin-msg-historial { margin: 1rem 0; padding: 0.75rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; max-height: 140px; overflow: hidden; }
.admin-msg-historial h4 { margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #0A2B32; }
.admin-msg-historial-list { max-height: 90px; overflow-y: auto; font-size: 0.85rem; }
.admin-msg-historial-item { padding: 6px 8px; margin-bottom: 4px; background: #fff; border-radius: 4px; border-left: 3px solid #0A2B32; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.admin-msg-historial-item .historial-time { font-size: 0.75rem; color: #888; margin-right: 8px; }
.admin-msg-historial-nav { display: flex; gap: 4px; margin-top: 6px; justify-content: center; }
.admin-msg-historial-nav button { padding: 2px 8px; font-size: 0.8rem; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer; }
.admin-msg-historial-nav button:hover { background: #f0f0f0; }
.admin-msg-historial-nav button.active { background: #0A2B32; color: #fff; border-color: #0A2B32; }
.admin-msg-historial-empty { color: #888; font-size: 0.85rem; font-style: italic; }
.admin-msg-unread-badge { background: #e67e22; color: #fff; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; margin-left: 4px; }
.admin-msg-conversacion { max-height: 220px; overflow-y: auto; margin: 1rem 0; padding: 0.75rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; }
.admin-msg-conv-item { padding: 8px 10px; margin-bottom: 6px; border-radius: 6px; font-size: 0.9rem; }
.admin-msg-conv-item.admin { background: #e8f4fd; border-left: 4px solid #0A2B32; }
.admin-msg-conv-item.client { background: #f0f0f0; border-left: 4px solid #6c757d; margin-left: 1rem; }
.admin-msg-conv-img { max-width: 160px; max-height: 100px; cursor: pointer; border-radius: 4px; margin-top: 6px; border: 1px solid #ddd; }
.admin-msg-conv-time { font-size: 0.75rem; color: #888; margin-top: 4px; }
.admin-btn-invoice { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 6px 12px; font-size: 0.85rem; background: #c97070; color: #fff; border-radius: 6px; text-decoration: none; border: 1px solid #b85c5c; }
.admin-btn-invoice:hover { background: #b85c5c; color: #fff; }
.admin-btn-save-ref { background: #28a745; color: #fff; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 6px; }
.admin-btn-save-ref:hover { background: #218838; }
</style>

<div id="admin-order-modal" class="admin-modal-overlay">
    <div class="admin-modal-content">
        <button type="button" class="admin-modal-close" id="admin-close-modal">&times;</button>
        <h2><i class="fas fa-file-alt"></i> Solicitud <span id="admin-modal-order-id"></span></h2>
        <div id="admin-order-detail-body"></div>
    </div>
</div>

<div id="admin-msg-modal" class="admin-modal-overlay">
    <div class="admin-modal-content admin-modal-content--wide">
        <button type="button" class="admin-modal-close" id="admin-close-msg">&times;</button>
        <h2 style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
            <span><i class="fas fa-comment"></i> Conversación - Pedido <span id="admin-msg-order-id"></span></span>
            <a id="admin-msg-invoice-link" href="#" target="_blank" rel="noopener" class="admin-btn-invoice" style="display:none;margin-left:auto;"><i class="fas fa-file-invoice"></i> Ver factura</a>
        </h2>
        <div id="admin-msg-conversacion" class="admin-msg-conversacion">
            <div id="admin-msg-conversacion-list"></div>
        </div>
        <div class="admin-msg-ref-pago" style="margin:1rem 0;padding:12px;background:#f8f9fa;border-radius:8px;border:1px solid #e9ecef;">
            <label style="display:block;font-weight:600;margin-bottom:6px;font-size:0.9rem;">Nº referencia del comprobante (para la factura)</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
                <input type="text" id="admin-payment-ref-input" placeholder="Pega aquí el nº de referencia del comprobante del cliente" maxlength="120" style="flex:1;min-width:200px;padding:8px 12px;border:1px solid #ddd;border-radius:6px;">
                <button type="button" id="admin-save-ref-btn" class="admin-btn-save-ref"><i class="fas fa-save"></i> Guardar</button>
            </div>
            <p style="font-size:0.8rem;color:#6c757d;margin-top:6px;">Al guardar, este número aparecerá en la factura del pedido.</p>
        </div>
        <p style="color:#666;font-size:0.9rem">El cliente verá tu mensaje en "Mis pedidos" &rarr; Mensajes.</p>
        <form id="admin-send-msg-form" class="admin-msg-form">
            {% csrf_token %}
            <input type="hidden" name="order_id" id="admin-msg-order-id-input">
            <label><span>Mensaje (datos de pago, observación, etc.)</span>
            <textarea name="message" required placeholder="Ej: Datos para transferencia: Banesco, cuenta 0102-xxxx, a nombre de..."></textarea></label>
            <button type="submit"><i class="fas fa-paper-plane"></i> Enviar</button>
        </form>
    </div>
</div>

<!-- Lightbox admin para comprobantes -->
<div id="admin-lightbox" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:10000;align-items:center;justify-content:center;padding:2rem;">
    <button type="button" onclick="document.getElementById('admin-lightbox').style.display='none'" style="position:absolute;top:1rem;right:1rem;background:none;border:none;color:#fff;font-size:2rem;cursor:pointer">&times;</button>
    <img id="admin-lightbox-img" src="" alt="Comprobante" style="max-width:95%;max-height:95%;object-fit:contain;border-radius:8px;">
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    var viewModal = document.getElementById('admin-order-modal');
    var msgModal = document.getElementById('admin-msg-modal');
    var detailBody = document.getElementById('admin-order-detail-body');
    var msgForm = document.getElementById('admin-send-msg-form');
    var baseUrl = '/orders/mis-pedidos/panel-admin';

    function renderDetail(d) {
        var html = '<div class="admin-detail-row"><strong>Cliente</strong><span>' + (d.user_email || '—') + '</span></div>';
        html += '<div class="admin-detail-row"><strong>Fecha</strong><span>' + d.created_at + '</span></div>';
        html += '<div class="admin-detail-row"><strong>Estado</strong><span>' + d.status + '</span></div>';
        html += '<div class="admin-detail-row"><strong>Método pago</strong><span>' + d.payment_method + '</span></div>';
        html += '<div class="admin-detail-row"><strong>Cédula/RIF</strong><span>' + d.document + '</span></div>';
        html += '<div class="admin-detail-row"><strong>Tipo envío</strong><span>' + d.shipping_type + '</span></div>';
        html += '<div class="admin-detail-row"><strong>Agencia</strong><span>' + d.shipping_agency + '</span></div>';
        html += '<div class="admin-detail-row"><strong>Retiro oficina</strong><span>' + (d.office_pickup ? 'Sí' : 'No') + '</span></div>';
        html += '<div class="admin-detail-row"><strong>Dirección</strong><span>' + d.shipping_address + '</span></div>';
        html += '<div class="admin-detail-row"><strong>Ciudad</strong><span>' + d.shipping_city + '</span></div>';
        html += '<div class="admin-detail-row"><strong>Teléfono</strong><span>' + d.shipping_phone + '</span></div>';
        html += '<div class="admin-detail-row"><strong>Total</strong><span>$' + d.total + '</span></div>';
        html += '<h4 style="margin-top:1rem;color:#0A2B32">Productos</h4>';
        (d.items || []).forEach(function(i) { html += '<div class="admin-detail-row"><span>' + i.name + ' x ' + i.quantity + '</span><span>$' + i.total + '</span></div>'; });
        if (d.notes && d.notes !== '—') html += '<div class="admin-detail-row"><strong>Notas</strong><span>' + d.notes + '</span></div>';
        return html;
    }
    document.querySelectorAll('.admin-order-view-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var id = this.getAttribute('data-order-id');
            var num = this.getAttribute('data-order-number');
            document.getElementById('admin-modal-order-id').textContent = '#' + num;
            fetch(baseUrl + '/pedido/' + id + '/detalle/').then(function(r) { return r.json(); }).then(function(d) {
                detailBody.innerHTML = renderDetail(d);
                viewModal.classList.add('is-open');
            });
        });
    });
    var adminBaseUrl = window.location.origin;

    function renderAdminConversacion(messages) {
        var listEl = document.getElementById('admin-msg-conversacion-list');
        if (!messages || messages.length === 0) {
            listEl.innerHTML = '<div class="admin-msg-historial-empty">No hay mensajes aún. Envía el primer mensaje al cliente.</div>';
            return;
        }
        var html = '';
        messages.forEach(function(m) {
            var cls = m.is_from_admin ? 'admin' : 'client';
            var label = m.is_from_admin ? 'MUXDRY' : 'Cliente';
            var fullImg = '';
            if (m.image_url) {
                var url = m.image_url.startsWith('http') ? m.image_url : adminBaseUrl + m.image_url;
                fullImg = '<img src="' + url + '" class="admin-msg-conv-img" alt="Comprobante" data-full="' + url + '">';
            }
            html += '<div class="admin-msg-conv-item ' + cls + '">';
            var txt = (m.message || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g, '<br>');
            html += '<div>' + txt + '</div>';
            html += fullImg;
            html += '<div class="admin-msg-conv-time">' + m.created_at + ' - ' + label + '</div></div>';
        });
        listEl.innerHTML = html;
        listEl.querySelectorAll('.admin-msg-conv-img').forEach(function(img) {
            img.addEventListener('click', function() {
                var lb = document.getElementById('admin-lightbox');
                var lbImg = document.getElementById('admin-lightbox-img');
                if (lb && lbImg) { lbImg.src = this.getAttribute('data-full'); lb.style.display = 'flex'; }
            });
        });
        listEl.scrollTop = listEl.scrollHeight;
    }

    document.querySelectorAll('.admin-order-msg-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var id = this.getAttribute('data-order-id');
            var num = this.getAttribute('data-order-number');
            document.getElementById('admin-msg-order-id').textContent = '#' + num;
            document.getElementById('admin-msg-order-id-input').value = id;
            document.querySelector('#admin-send-msg-form textarea').value = '';
            msgModal.classList.add('is-open');
            fetch(baseUrl + '/pedido/' + id + '/detalle/?mark_client_read=1').then(function(r) { return r.json(); }).then(function(d) {
                renderAdminConversacion(d.messages || []);
                var refInput = document.getElementById('admin-payment-ref-input');
                if (refInput) refInput.value = d.payment_reference || '';
                var invoiceLink = document.getElementById('admin-msg-invoice-link');
                if (invoiceLink) {
                    if (d.status === 'delivered') { invoiceLink.href = adminBaseUrl + '/orders/pedido/' + id + '/factura/'; invoiceLink.style.display = 'inline-flex'; }
                    else { invoiceLink.style.display = 'none'; }
                }
                var badge = btn.querySelector('.admin-msg-unread-badge');
                if (badge) badge.remove();
                if (typeof window.refreshOrdersUnreadBadges === 'function') window.refreshOrdersUnreadBadges();
            }).catch(function() { renderAdminConversacion([]); });
        });
    });
    var saveRefBtn = document.getElementById('admin-save-ref-btn');
    var refInput = document.getElementById('admin-payment-ref-input');
    if (saveRefBtn && refInput) {
        saveRefBtn.addEventListener('click', function() {
            var orderId = document.getElementById('admin-msg-order-id-input').value;
            if (!orderId) { alert('Abre primero la conversación de un pedido.'); return; }
            var fd = new FormData();
            fd.append('order_id', orderId);
            fd.append('payment_reference', refInput.value.trim());
            fd.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            saveRefBtn.disabled = true;
            saveRefBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            fetch('/orders/mis-pedidos/panel-admin/pedido/referencia-pago/', { method: 'POST', body: fd, headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    saveRefBtn.disabled = false;
                    saveRefBtn.innerHTML = '<i class="fas fa-save"></i> Guardar';
                    if (data.ok) alert('Referencia guardada. Aparecerá en la factura.'); else alert(data.error || 'Error al guardar.');
                })
                .catch(function() { saveRefBtn.disabled = false; saveRefBtn.innerHTML = '<i class="fas fa-save"></i> Guardar'; alert('Error de conexión.'); });
        });
    }
    document.getElementById('admin-close-modal').onclick = function() { viewModal.classList.remove('is-open'); };
    document.getElementById('admin-close-msg').onclick = function() { msgModal.classList.remove('is-open'); };
    viewModal.addEventListener('click', function(e) { if (e.target === viewModal) viewModal.classList.remove('is-open'); });
    msgModal.addEventListener('click', function(e) { if (e.target === msgModal) msgModal.classList.remove('is-open'); });
    msgForm.addEventListener('submit', function(e) {
        e.preventDefault();
        var fd = new FormData(msgForm);
        var orderId = document.getElementById('admin-msg-order-id-input').value;
        fetch(baseUrl + '/enviar-mensaje/', { method: 'POST', body: fd, headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value, 'X-Requested-With': 'XMLHttpRequest' } })
            .then(function(r) { return r.json(); })
            .then(function(res) {
                if (res.ok) {
                    alert('Mensaje enviado. El cliente lo verá en Mis pedidos.');
                    fetch(baseUrl + '/pedido/' + orderId + '/detalle/').then(function(r2) { return r2.json(); }).then(function(d) {
                        renderAdminConversacion(d.messages || []);
                    });
                    document.querySelector('#admin-send-msg-form textarea').value = '';
                } else { alert('Error: ' + (res.error || 'No se pudo enviar')); }
            });
    });

    var adminLightbox = document.getElementById('admin-lightbox');
    if (adminLightbox) adminLightbox.addEventListener('click', function(e) { if (e.target === adminLightbox) adminLightbox.style.display = 'none'; });
})();
</script>
{% endblock %}
