{% extends 'base.html' %}
{% load static %}
{% load product_images %}

{% block title %}Carrito de compras - MUXDRY{% endblock %}

{% block extra_css %}
<style>
.cart-page-wrap { max-width: 1100px; margin: 0 auto; padding: 24px 16px 48px; background: #f5f6f8; min-height: 60vh; }
.cart-profile-header {
    display: flex; align-items: center; gap: 1.5rem;
    background: #fff; padding: 1.5rem 2rem; border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.06); margin-bottom: 1.5rem;
}
.cart-profile-header .profile-avatar__custom-ui-2 { flex-shrink: 0; }
.cart-profile-header .profile-name__custom-ui-2 { font-size: 1.25rem; margin: 0 0 0.2rem 0; color: #0A2B32; }
.cart-profile-header .profile-email__custom-ui-2 { margin: 0; font-size: 0.9rem; color: #6c757d; }
.cart-profile-online { display: inline-flex; align-items: center; gap: 0.35rem; font-size: 0.85rem; color: #0a7c42; margin-left: auto; }
.cart-profile-online i { font-size: 0.6rem; }
.cart-page-title { font-size: 1.5rem; font-weight: 700; color: #0A2B32; margin-bottom: 0.5rem; }
.cart-page-subtitle { color: #6c757d; font-size: 0.95rem; margin-bottom: 1.5rem; }
.cart-layout { display: grid; grid-template-columns: 1fr 340px; gap: 24px; align-items: start; }
@media (max-width: 900px) { .cart-layout { grid-template-columns: 1fr; } }
.cart-items-block {
    background: #fff; border-radius: 12px; border: 1px solid #e5e9ec;
    box-shadow: 0 2px 10px rgba(0,0,0,0.04); overflow: hidden;
}
.cart-item-row {
    display: grid;
    grid-template-columns: 120px 1fr auto auto auto;
    gap: 16px;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid #eee;
}
.cart-item-row:last-child { border-bottom: none; }
.cart-item-img {
    width: 110px; height: 110px; object-fit: contain;
    border-radius: 8px; background: #f8f9fa;
}
.cart-item-details { min-width: 0; }
.cart-item-name { font-weight: 600; color: #1a1a1a; font-size: 1.05rem; margin-bottom: 4px; }
.cart-item-price { color: #0A2B32; font-weight: 600; font-size: 1rem; }
.cart-item-qty-wrap { display: flex; align-items: center; gap: 4px; margin-top: 6px; }
.cart-item-qty-wrap form { display: inline-flex; align-items: center; gap: 0; }
.cart-qty-btn { width: 28px; height: 28px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer; font-size: 1rem; line-height: 1; color: #333; }
.cart-qty-btn:hover { background: #f0f0f0; }
.cart-qty-val { min-width: 32px; text-align: center; font-weight: 600; font-size: 0.95rem; }
.cart-item-total { font-weight: 700; color: #0A2B32; white-space: nowrap; font-size: 1.1rem; }
.cart-item-actions form { margin-right: 8px; }
.cart-item-buy-single { padding: 6px 12px; background: #0A2B32; color: #fff; border: 1px solid #0A2B32; border-radius: 6px; font-size: 0.8rem; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; }
.cart-item-buy-single:hover { background: #0d3840; color: #fff; }
.cart-item-remove { padding: 6px 12px; background: transparent; border: 1px solid #dc3545; color: #dc3545; border-radius: 6px; font-size: 0.8rem; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; }
.cart-item-remove:hover { background: #dc3545; color: #fff; }
.cart-pagination { display: flex; justify-content: center; gap: 8px; margin-top: 1rem; padding: 1rem; }
.cart-pagination a, .cart-pagination span { padding: 8px 14px; border-radius: 6px; text-decoration: none; color: #0A2B32; font-weight: 500; border: 1px solid #ddd; background: #fff; }
.cart-pagination a:hover { background: #f0f0f0; }
.cart-pagination .current { background: #0A2B32; color: #fff; border-color: #0A2B32; }
.cart-summary {
    background: #fff;
    border: 1px solid #e5e9ec;
    border-radius: 12px;
    padding: 24px;
    position: sticky;
    top: 24px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.04);
}
.cart-summary-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 1rem; color: #0A2B32; }
.cart-summary-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 1rem; }
.cart-summary-total { font-size: 1.25rem; font-weight: 700; color: #0A2B32; margin-top: 16px; padding-top: 16px; border-top: 2px solid #eee; }
.cart-submit-btn {
    display: block;
    width: 100%;
    margin-top: 20px;
    padding: 16px 20px;
    background: #e67e22;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    text-align: center;
}
.cart-submit-btn:hover { background: #d35400; }
.cart-continue-link { display: block; text-align: center; margin-top: 14px; color: #0A2B32; font-size: 0.95rem; text-decoration: none; }
.cart-continue-link:hover { text-decoration: underline; }
.cart-empty {
    text-align: center; padding: 56px 24px; background: #fff; border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.04);
}
.cart-empty h2 { font-size: 1.35rem; color: #0A2B32; margin-bottom: 10px; }
.cart-empty p { color: #6c757d; margin-bottom: 24px; }
.cart-empty a { display: inline-block; padding: 14px 28px; background: #0A2B32; color: #fff; border-radius: 8px; font-weight: 600; text-decoration: none; }
.cart-empty a:hover { background: #0d3840; }
@media (max-width: 600px) {
    .cart-page-wrap { padding: 16px 12px 32px; }
    .cart-item-row {
        grid-template-columns: 80px 1fr;
        gap: 12px;
        padding: 16px;
    }
    .cart-item-total { grid-column: 2; text-align: left; }
    .cart-item-actions { grid-column: 2; margin-top: 8px; }
    .cart-summary { position: static; }
}
</style>
{% endblock %}

{% block content %}
<div class="cart-page-wrap">
    <div class="cart-profile-header">
        <div class="profile-avatar__custom-ui-2">
            <img src="{% static 'assets/Perfil-Default.jpeg' %}" alt="Perfil" class="profile-logo__custom-ui-2">
        </div>
        <div class="profile-info__custom-ui-2">
            <h1 class="profile-name__custom-ui-2">{{ user.get_full_name|default:user.username }}</h1>
            <p class="profile-email__custom-ui-2">{{ user.email|default:"" }}</p>
        </div>
        <span class="cart-profile-online"><i class="fas fa-circle"></i> En línea</span>
    </div>

    <h2 class="cart-page-title">Carrito de compras</h2>
    <p class="cart-page-subtitle">Revisa tus productos y realiza tu solicitud de pedido.</p>

    {% if items %}
    <div class="cart-layout">
        <div>
        <div class="cart-items-block">
            {% for item in items %}
            <div class="cart-item-row">
                <img src="{% product_image_url item.product %}" alt="{{ item.product.name }}" class="cart-item-img">
                <div class="cart-item-details">
                    <div class="cart-item-name">{{ item.product.name }}</div>
                    <div class="cart-item-price">${{ item.product.price }}</div>
                    <div class="cart-item-qty-wrap">
                        <form method="post" action="{% url 'orders:update_cart_item' %}" style="display:inline;">
                            {% csrf_token %}
                            <input type="hidden" name="item_id" value="{{ item.id }}">
                            <input type="hidden" name="delta" value="-1">
                            <button type="submit" class="cart-qty-btn" title="Menos">−</button>
                        </form>
                        <span class="cart-qty-val">{{ item.quantity }}</span>
                        <form method="post" action="{% url 'orders:update_cart_item' %}" style="display:inline;">
                            {% csrf_token %}
                            <input type="hidden" name="item_id" value="{{ item.id }}">
                            <input type="hidden" name="delta" value="1">
                            <button type="submit" class="cart-qty-btn" title="Más">+</button>
                        </form>
                    </div>
                </div>
                <div class="cart-item-total">${{ item.total_price }}</div>
                <div class="cart-item-actions">
                    <form method="post" action="{% url 'orders:create_order_single_item' %}" style="display:inline;">
                        {% csrf_token %}
                        <input type="hidden" name="item_id" value="{{ item.id }}">
                        <button type="submit" class="cart-item-buy-single" title="Comprar solo este producto"><i class="fas fa-shopping-bag"></i> Comprar solo este producto</button>
                    </form>
                    <form method="post" action="{% url 'orders:remove_cart_item' %}" style="display:inline;">
                        {% csrf_token %}
                        <input type="hidden" name="item_id" value="{{ item.id }}">
                        <button type="submit" class="cart-item-remove" title="Eliminar del carrito"><i class="fas fa-trash-alt"></i> Quitar</button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>

        {% if page_obj.paginator.num_pages > 1 %}
        <div class="cart-pagination">
            {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}">&laquo; Anterior</a>
            {% endif %}
            {% for n in page_obj.paginator.page_range %}
            {% if page_obj.number == n %}
            <span class="current">{{ n }}</span>
            {% else %}
            <a href="?page={{ n }}">{{ n }}</a>
            {% endif %}
            {% endfor %}
            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}">Siguiente &raquo;</a>
            {% endif %}
        </div>
        {% endif %}
        </div>

        <div class="cart-summary">
            <h2 class="cart-summary-title">Resumen del pedido</h2>
            <div class="cart-summary-row">
                <span>Subtotal ({{ cart.item_count }} {% if cart.item_count == 1 %}producto{% else %}productos{% endif %})</span>
                <span>${{ total }}</span>
            </div>
            <div class="cart-summary-row cart-summary-total">
                <span>Total</span>
                <span>${{ total }}</span>
            </div>
            <form method="post" action="{% url 'orders:create_order_from_cart' %}">
                {% csrf_token %}
                <button type="submit" class="cart-submit-btn">Realizar solicitud de pedido</button>
            </form>
            <a href="{% url 'home' %}" class="cart-continue-link">Seguir comprando</a>
        </div>
    </div>
    {% else %}
    <div class="cart-empty">
        <h2>Tu carrito está vacío</h2>
        <p>Añade productos desde la tienda para continuar.</p>
        <a href="{% url 'home' %}">Ir a la tienda</a>
    </div>
    {% endif %}
</div>
{% endblock %}
